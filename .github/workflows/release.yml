name: CI/CD Pipeline

on:
  push:
    branches:
      - master

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    
    # Define environment variables (optional, but helpful for clarity)
    env:
      NEXUS_URL: 'http://65.2.35.91:8081' # e.g., mycompany.com/nexus

    steps:
    
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4

      # 1. Setup the Java/Maven environment
      - name: ğŸ› ï¸ Setup Java and Maven
        uses: actions/setup-java@v4
        with:
          java-version: '17' # Choose your required Java version
          distribution: 'temurin'
          # CRITICAL STEP: Configure Maven to use Nexus credentials from secrets
          server-id: nexus-snapshots # Matches the ID in pom.xml/settings.xml
          server-username: ${{ secrets.NEXUS_USERNAME }}
          server-password: ${{ secrets.NEXUS_PASSWORD }}
          
      # 2. Build the project and run tests
      - name: ğŸ—ï¸ Build with Maven
        run: mvn clean install -DskipTests

      - name: ğŸ“ Manually Create settings.xml
        run: |
          mkdir -p ~/.m2
          cat <<EOF > ~/.m2/settings.xml
          <settings>
            <servers>
              <server>
                <id>nexus-snapshots</id>
                <username>${{ secrets.NEXUS_USERNAME }}</username>
                <password>${{ secrets.NEXUS_PASSWORD }}</password>
              </server>
            </servers>
          </settings>
          EOF

      # 3. Deploy the artifact to Nexus (only for 'main' branch in this example)
      - name: ğŸš€ Deploy to Nexus Repository
        
        # The 'deploy' goal uses the distributionManagement section in pom.xml
        # and the credentials injected by 'setup-java'
        
        run: mvn deploy -DskipTests
