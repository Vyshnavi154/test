name: Build and Deploy WAR

on:
  push:
    branches:
      - master
      - developer

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:

    # -------------------------
    # 1. Checkout Repository
    # -------------------------
    - name: Checkout SCM
      uses: actions/checkout@v4

    # -------------------------
    # 2. Set up Java
    # -------------------------
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # -------------------------
    # 3. Build WAR File
    # -------------------------
    - name: Build WAR
      run: mvn clean package

    # -------------------------
    # 4. Determine Deploy Server
    # -------------------------
    - name: Set Deployment Server Based on Branch
      id: set-server
      run: |
        if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
          echo "SERVER_IP=13.201.5.148" >> $GITHUB_ENV
        elif [[ "${{ github.ref }}" == "refs/heads/developer" ]]; then
          echo "SERVER_IP=13.235.82.52" >> $GITHUB_ENV
        else
          echo "Branch not configured for deployment"
          exit 1
        fi

    # -------------------------
    # 5. Deploy using SSH + SCP
    # -------------------------
    - name: Deploy WAR to Server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ env.SERVER_IP }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "target/*.war"
        target: "/home/ubuntu"
        overwrite: true

  
